{{- partial "core/set-env.html" . -}}
{{- $list := .Data.Pages -}}
{{- $length := (len $list) -}}
{
    "version" : "https://jsonfeed.org/version/1",
    "content" : "{{- .Type -}}",
    "type" : "single",
    "title" : "{{- if eq  .Title  .Site.Title -}}{{- .Site.Title -}}{{- else -}}{{- with .Title -}} {{.}} |  {{- end -}} {{- .Site.Title -}} {{- end -}}",
    "description": "{{- if ne  .Title  .Site.Title -}}{{- with .Title -}}{{.}}{{- end -}}{{- end -}}",
    "home_page_url" : "{{- .Site.BaseURL -}}",
    {{- with .OutputFormats.Get "JSON" -}}
    "feed_url" : "{{- .Permalink -}}",
    {{- end -}}
    {{- with $.Param "icon" -}}
    "icon" : "{{- . | absURL -}}",
    {{- end -}}
    {{- with $.Param "favicon" -}}
    "favicon" : "{{- . | absURL -}}",
    {{- end -}}
    {{- with .Site.Author.name -}}
    "author" : {
        "name" : "{{- . -}}"{{- with $.Site.Author.url -}},
        "url": "{{- . -}}"{{- end -}}{{- with $.Site.Author.avatar -}},
        "avatar": "{{- . | absURL -}}"{{- end -}}
    },
    {{- end -}}
    {{ define "content" }}
    {{- .Content -}}
    {{- end -}}
    "item" : [
    {
      "title" : {{- .Title | jsonify -}},
      {{- if (isset .Params "summary") -}}
      "summary" : "{{- .Params.summary -}}",
      {{- end -}}
      {{- if (isset .Params "deck") -}}
      "deck" : "{{- .Params.deck | markdownify -}}",
      {{- end -}}
      "date" : "{{- .Date.Format "2006-01-02T15:04:05Z07:00" -}}",
      {{- if .Lastmod -}}
      "date_modified" : "{{- .Date.Format "2006-01-02T15:04:05Z07:00" -}}",
      {{- else -}}
      "date_modified" : "{{- .LastMod.Format "2006-01-02T15:04:05Z07:00" -}}",
      {{- end -}}
      {{- if (isset .Params "authors") -}}
        {{- $_authors := .Params.authors -}}
        {{- $length := $_authors | len -}}
        "authors" : {
        {{- range $i, $e := $_authors -}}
          {{- $uid := $e | urlize -}}
          {{- $author := $.Site.GetPage (printf "/%s/%s" "authors" $uid) -}}
          {{- with $author -}}
            {{- if lt (add $i 1) $length -}}
              "{{- $uid -}}" : "{{- $author.Params.display_name | default $uid }}",
            {{- else -}}
              "{{- $uid -}}" : "{{- $author.Params.display_name | default $uid }}"
            {{- end -}}
          {{- end -}}
        {{- end -}}
        },
      {{- end -}}

      {{- if (not (isset .Params "topics")) | or (eq .Params.topics "") -}}
      {{- else -}}
        "topics" : {
        {{/* Sets the taxonomy we're pulling here */}}
        {{- $taxonomy := "topics" -}}
        {{- $topics := .Param $taxonomy -}}
        {{/* Gets the number of topics that are applied */}}
        {{- $length := $topics | len -}}

        {{/* For each of the topics,... */}}
        {{- range $i, $e := sort $topics -}}
          {{- $slug := . -}}
          {{/* Gets the Topics page */}}
          {{- with $.Site.GetPage (printf "/%s/%s" $taxonomy $slug) -}}
            {{ if lt (add $i 1) $length }}
            "{{- $slug -}}" : "{{- .Title }}",
            {{- else }}
            "{{- $slug -}}" : "{{- .Title }}"
            {{ end }}
          {{- end -}}

        {{- end -}}
        },
      {{- end -}}

      {{- if (isset .Params "community_list") -}}
        "community_list" : {

          {{- $community_lists := .Params.community_list -}}
          {{- $length := $community_lists | len -}}
          {{- $.Scratch.Set "count" 1 -}}
          {{/* For each of the $community_lists,... */}}
          {{- range $index, $list := $community_lists -}}
            {{/* If there is a list... */}}
            {{- with $list -}}
              {{/* get the count */}}
              {{- $count := $.Scratch.Get "count" -}}
              "list_{{ $count }}" : {
              {{/* number of lists */}}
              {{- $sub_length := $list | len -}}

              {{- $.Scratch.Set "sub_count" 1 -}}
              {{- range $i, $e := $list -}}
                {{- with $e -}}
                  {{- $sub_count := $.Scratch.Get "sub_count" -}}
                  {{- if eq $sub_count $sub_length -}}
                    "{{- $i -}}" : "{{- $e -}}"
                  {{- else -}}
                    "{{- $i -}}" : "{{- $e -}}",
                  {{- end -}}
                  {{- $.Scratch.Add "sub_count" 1 -}}
                {{- end -}}
              {{- end -}}
              }{{- if eq $count $length -}}{{- else -}},{{- end -}}{{- $.Scratch.Add "count" 1 -}}
            {{- end -}}
          {{- end -}}
        },
      {{- end -}}
      "branch" : {{ $.Scratch.Get "branch" | jsonify }},
      "filename" : {{ .File.LogicalName | jsonify }},
      "filepath" : {{ .File.Path | jsonify }},
      "filepathURL" : {{ printf "https://github.com/%s/%s/blob/%s/content/%s" $.Site.Params.git_org $.Site.Params.git_repo ($.Scratch.Get "branch") .File.Path | jsonify }},
      "editpathURL" : {{ printf "https://github.com/%s/%s/edit/%s/content/%s" $.Site.Params.git_org $.Site.Params.git_repo ($.Scratch.Get "branch") .File.Path | jsonify }},
      {{- if .Params.source -}}
      "source" : "{{- .Params.source -}}",
      {{- end -}}
      {{- if .Params.source_url -}}
      "source_url" : "{{- .Params.source_url -}}",
      {{- end -}}
      "url" : "{{- .Permalink -}}",
      "content" : {{- .Content | jsonify -}}
    }
  ]
}
