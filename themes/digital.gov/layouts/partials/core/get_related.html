{{/* ======================================
  Related Communities and Services
  ======================================
*/}}

{{/* Communities ====================== */}}

{{/* gets all pages in the site that are related */}}
{{- $related_pages := .Site.Pages.Related  . -}}

{{/* gets only the related community pages */}}
{{- $.Scratch.Set "communities" (where $related_pages "Section" "communities") -}}

{{/* Now conditionally shuffle the community pages and pick the first 5 */}}
{{ if (gt (len ($.Scratch.Get "communities")) 5) }}
  {{- $.Scratch.Set "communities" (first 5 ($.Scratch.Get "communities") | shuffle) -}}
{{ end }}
{{ $communities := ($.Scratch.Get "communities") }}

{{/* If there are community pages... */}}
{{- with $communities -}}
  <section id="related-communities" class="dg-promos dg-related-communities">
    <h4 class="dg-promos__heading">Join a Community</h4>

    <ul class="dg-promos__list">
      {{- range $communities -}}
        <li class="promo dg-promos__list-item">
          <a
            href="{{ .Permalink }}?promo"
            title="Visit {{ .Title }} community page"
            class="dg-promos__link"
          >
            {{ .Title }}

            {{ range .Page.Params.community_list }}
              {{ if .members }}
                <span class="dg-community__count">
                  {{- .members -}}+ <span class="usa-sr-only"> members</span>
                </span>
              {{ end }}
            {{ end }}
          </a>
        </li>
      {{- end -}}
    </ul>

    <footer class="dg-promos__footer">
      {{ $communityCount := len (where $.Site.RegularPages "Section" "communities") }}


      <a
        href="{{ "/communities/" | absURL }}"
        class="dg-promos__more-link dg-more-link"
      >
        <span> See all {{ $communityCount }} communities </span>
        <svg
          class="usa-icon dg-icon dg-icon--small margin-bottom-05"
          aria-hidden="true"
          focusable="false"
        >
          <use
            xlink:href="{{ "uswds/img/sprite.svg#arrow_forward" | relURL }}"
          ></use>
        </svg>
      </a>
    </footer>
  </section>
{{- end -}}

{{/* Services ====================== */}}

{{/* gets only the related service pages */}}
{{- $services := where $related_pages "Section" "services" -}}

{{- $.Scratch.Set "services" (where $related_pages "Section" "services") -}}

{{/* Now conditionally shuffle the service pages and pick the first 5 */}}
{{ if (gt (len ($.Scratch.Get "services")) 5) }}
  {{- $.Scratch.Set "services" (first 5 ($.Scratch.Get "services") | shuffle) -}}
{{ end }}
{{ $services := ($.Scratch.Get "services") }}

{{/* If there are services... */}}
{{- with $services -}}
  <section id="related_services" class="dg-promos dg-related-services">
    <h4 class="dg-promos__heading">Get Started Building</h4>

    <ul class="dg-promos__list">
      {{- range $services -}}

        {{/* If an external link */}}
        {{- if or .Params.source_url .Params.source -}}

          {{/* If there is a defined source for this page */}}
          {{- if .Params.source -}}
            {{/* Get the source data */}}
            {{- $source := .Site.GetPage (print "source_" .Params.source ) -}}
            {{/* If there is a logo defined in the source */}}
            {{- if $source.Params.logo -}}
              {{/* get the path for the icon â€” e.g. 18f-icon.png */}}
              {{- $src := (printf "/logos/%s%s" $source.Params.logo "-icon.png") -}}
              {{/* Pass these vars into the list item template (botton of page) */}}

              {{- template "promo" dict "item" . "href" (print .Params.source_url "?dg") "src" $src -}}
            {{- end -}}
            {{/* No source? let's attempt to get the favicon for the URL */}}
          {{- else -}}
            {{/* get the Favicon via Google Favicon service */}}
            {{- $src := (print "https://www.google.com/s2/favicons?domain=" .Params.source_url) -}}
            {{/* Pass these vars into the list item template (botton of page) */}}
            {{- template "promo" dict "item" . "href" (print .Params.source_url "?dg") "src" $src -}}
          {{- end -}}

          {{/* If an internal link... */}}
        {{- else -}}

          {{/* Use the digital.gov logo */}}
          {{/* Pass these vars into the list item template (botton of page) */}}
          {{- template "promo" dict "item" . "href" (print .Params.source_url "?dg") "src" (print "/img/digit-50.png") -}}

        {{- end -}}

      {{- end -}}

    </ul>

    <footer>
      <p>
        <a href="{{ "/services/" | absURL }}" class="dg-more-link"
          ><span
            >See all
            {{ len (where $.Site.RegularPages "Section" "services") }}
            services</span
          >
          <svg
            class="usa-icon dg-icon dg-icon--small margin-bottom-05"
            aria-hidden="true"
            focusable="false"
          >
            <use
              xlink:href="{{ "uswds/img/sprite.svg#arrow_forward" | relURL }}"
            ></use>
          </svg>
        </a>
      </p>
    </footer>
  </section>
{{- end -}}

{{- define "promo" -}}
  {{- $href := .href -}}
  {{- $src := .src -}}
  {{- with .item -}}
    {{ $path := "" }}{{ with .File }}
      {{ $path = .Path }}
    {{ else }}
      {{ $path = .Path }}
    {{ end }}


    <li class="dg-promos__list-item" data-gh-edit-page="{{- $path -}}">
      {{ $sourceUrl := .Permalink }}

      {{- if isset .Params "source_url" }}
        {{ $sourceUrl = .Params.source_url }}
      {{- end -}}


      <a
        class="dg-promos__link dg-promos__link--has-media external-link"
        href="{{- $sourceUrl -}}"
        title="Visit {{ .Title | markdownify -}} services page"
      >
        <span>{{- .Title | markdownify -}}</span>
        <img
          class="dg-promos__img"
          src="{{- $src | relURL -}}"
          alt=""
          aria-hidden="true"
          height="24"
          width="24"
        />
      </a>
    </li>
  {{- end -}}
{{- end -}}
