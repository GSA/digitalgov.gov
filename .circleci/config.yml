version: 2.1

orbs:
  hugo: circleci/hugo@1.3.1
  node: circleci/node@5.2.0

defaults: &defaults
  executor:
    name: node/default
    tag: "lts"

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Read Hugo version
          command: echo "HUGO_VERSION=$(cat .hugo-version)" >> $BASH_ENV
      - hugo/install:
          version: ${HUGO_VERSION}
      - node/install-packages:
          cache-path: ~/project/node_modules
          override-ci-command: npm install
      - run:
          name: Build assets
          command: npm run federalist
      - run:
          name: Build with Hugo
          command: HUGO_ENV=production hugo -v -s . -d public
      - persist_to_workspace:
          paths:
            - node_modules
            - public
          root: .

  # ... rest of the configuration remains the same ...

workflows:
  build_test_process:
    jobs:
      - build
      - html-proofer:
          requires:
            - build
      - test:
          requires:
            - build
      - process:
          requires:
            - html-proofer
            - test
          filters:
            branches:
              ignore: main